<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Billing Pro | Tushar Dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-50 font-sans select-none overflow-x-hidden text-slate-900">

    <div id="loginPage" class="fixed inset-0 z-[2000] bg-white flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-10 tracking-tighter italic text-slate-900 underline decoration-blue-600 underline-offset-8 uppercase">Cloud Billing</h1>
            <input id="uId" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <input id="uPass" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-5 rounded-[25px] font-black text-lg shadow-xl active:scale-95 transition">SIGN IN</button>
        </div>
    </div>

    <div id="mainApp" class="hidden min-h-screen">
        <header class="bg-white p-6 shadow-sm sticky top-0 z-50 pt-10 border-b">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <img id="sideLogo" src="" class="w-10 h-10 rounded-xl object-contain border hidden shadow-sm">
                    <h1 id="headerShop" class="text-lg font-black uppercase italic tracking-tighter text-slate-800"></h1>
                </div>
                <button onclick="doLogout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase">Logout</button>
            </div>
            <div class="bg-slate-900 text-white p-3 rounded-2xl flex justify-between items-center px-6 shadow-lg">
                <div id="liveDate" class="text-[10px] font-bold opacity-70 uppercase tracking-widest">--/--/----</div>
                <div id="liveTime" class="text-lg font-black italic tracking-tighter">00:00:00</div>
            </div>
        </header>

        <div id="billingPage" class="p-4 space-y-6 pb-40">
            <div class="bg-white p-6 rounded-[35px] border shadow-sm space-y-4">
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="cA" placeholder="Customer Address" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <div class="grid grid-cols-2 gap-3">
                    <input id="dBrand" placeholder="Brand Name" class="p-4 bg-slate-50 rounded-2xl border font-bold uppercase">
                    <input id="dModel" placeholder="Model Name" class="p-4 bg-slate-50 rounded-2xl border font-bold uppercase">
                </div>
                <input id="imei" placeholder="IMEI / Serial No." class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold tracking-widest">
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalP" type="number" onkeyup="reCalc()" placeholder="Total Price" class="p-4 bg-slate-50 rounded-2xl border font-black text-blue-600 text-center text-xl">
                    <div id="finalVal" class="p-4 bg-blue-600 rounded-2xl text-white font-black flex items-center justify-center italic shadow-inner">â‚¹0</div>
                </div>
                <select id="payMode" onchange="toggleEMI()" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold text-center">
                    <option value="Full">Full Paid</option>
                    <option value="EMI">EMI / Pending</option>
                </select>
                <div id="emiSection" class="hidden space-y-4 p-5 bg-blue-50/50 rounded-[30px] border border-blue-100">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-2xl border font-black text-center text-blue-600">
                    <input id="emiMonths" type="number" onkeyup="reCalc()" placeholder="Months" class="w-full p-4 bg-white rounded-2xl border font-bold text-center">
                    <div class="flex justify-between items-center px-4 py-2 text-blue-700 font-black"><span class="text-[10px]">MONTHLY EMI:</span><span id="mEmi">â‚¹0</span></div>
                </div>
            </div>
            <button onclick="generateBill()" class="w-full bg-slate-900 text-white py-6 rounded-[30px] font-black text-xl shadow-2xl active:scale-95 transition">GENERATE & DOWNLOAD BILL</button>
        </div>

        <div id="ledgerPage" class="hidden p-4 space-y-4 pb-40">
            <div class="bg-white p-3 rounded-[25px] shadow-sm sticky top-28 z-40 border">
                <input id="searchBox" onkeyup="searchLedger()" placeholder="ðŸ” Search Customer..." class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold text-center">
            </div>
            <div id="billHistory" class="space-y-4"></div>
        </div>

        <div id="qrcode" class="hidden"></div>

        <nav class="fixed bottom-8 left-8 right-8 h-20 bg-slate-900/95 backdrop-blur-md rounded-[45px] flex items-center justify-around px-8 shadow-2xl z-[500]">
            <button onclick="tab('billing')" class="text-white text-[10px] font-black uppercase tracking-widest">New Bill</button>
            <button onclick="tab('ledger')" class="text-slate-500 text-[10px] font-black uppercase tracking-widest">History</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let shop = null, shopId = null, allBills = [];

        // LIVE CLOCK
        setInterval(() => {
            const now = new Date();
            document.getElementById('liveDate').innerText = now.toLocaleDateString('en-GB');
            document.getElementById('liveTime').innerText = now.toLocaleTimeString('en-GB', { hour12: true });
        }, 1000);

        window.doLogin = () => {
            const u = document.getElementById('uId').value.toLowerCase().trim();
            const p = document.getElementById('uPass').value;
            onValue(ref(db, `shops/${u}`), (snap) => {
                const d = snap.val();
                if(d && d.config.pass === p) {
                    shop = d.config; shopId = u;
                    localStorage.setItem('saved_u', u);
                    startApp();
                } else alert("Invalid Login!");
            }, {onlyOnce: true});
        };

        window.doLogout = () => { localStorage.clear(); location.reload(); };

        function startApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerShop').innerText = shop.name;
            if(shop.logo) { document.getElementById('sideLogo').src = shop.logo; document.getElementById('sideLogo').classList.remove('hidden'); }
            loadLedger(); // Real-time listener start
        }

        window.reCalc = () => {
            const p = parseFloat(document.getElementById('totalP').value || 0);
            document.getElementById('finalVal').innerText = "â‚¹" + p;
            if(document.getElementById('payMode').value === "EMI") {
                const dp = parseFloat(document.getElementById('downPay').value || 0);
                const m = parseFloat(document.getElementById('emiMonths').value || 1);
                document.getElementById('mEmi').innerText = "â‚¹" + Math.round((p - dp) / m);
            }
        };

        window.toggleEMI = () => document.getElementById('emiSection').classList.toggle('hidden', document.getElementById('payMode').value !== 'EMI');

        window.generateBill = () => {
            const now = new Date();
            const b = {
                name: document.getElementById('cN').value, phone: document.getElementById('cP').value,
                addr: document.getElementById('cA').value, brand: document.getElementById('dBrand').value,
                model: document.getElementById('dModel').value, imei: document.getElementById('imei').value,
                total: parseFloat(document.getElementById('totalP').value),
                paid: parseFloat(document.getElementById('downPay').value || document.getElementById('totalP').value),
                months: document.getElementById('emiMonths').value || 0,
                date: now.toLocaleDateString(), time: now.toLocaleTimeString(), timestamp: Date.now()
            };
            if(!b.name || !b.total) return alert("Fill Name & Price!");
            push(ref(db, `data/${shopId}/bills`), b).then(() => createPDF(b));
        };

        async function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const bal = b.total - b.paid;

            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 45, 'F');
            if(shop.logo) {
                try {
                    const img = new Image(); img.src = shop.logo; img.crossOrigin = "Anonymous";
                    await new Promise(r => img.onload = r);
                    doc.addImage(img, 'PNG', 15, 8, 28, 28);
                } catch(e) {}
            }
            doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text(shop.name.toUpperCase(), 45, 18);
            doc.setFontSize(8); doc.text(`Date: ${b.date} | Time: ${b.time}`, 45, 36);

            doc.autoTable({
                startY: 65, head: [['CUSTOMER', 'PRODUCT']],
                body: [[`${b.name}\n${b.phone}`, `${b.brand} ${b.model}\n${b.imei}`]],
                theme: 'grid'
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10, head: [['SUMMARY', 'AMOUNT']],
                body: [['Total', 'Rs. '+b.total], ['Paid', 'Rs. '+b.paid], ['Balance', 'Rs. '+bal]],
                theme: 'striped', headStyles: { fillColor: [15, 23, 42] }
            });

            const igUrl = `https://instagram.com/${shop.insta}`;
            const qrDiv = document.getElementById('qrcode'); qrDiv.innerHTML = "";
            new QRCode(qrDiv, { text: igUrl, width: 100, height: 100 });
            
            setTimeout(() => {
                const qrImg = qrDiv.querySelector('img').src;
                doc.addImage(qrImg, 'PNG', 90, 250, 30, 30);
                
                // ðŸ”¥ THE DOWNLOAD FIX: BLOB FORCED DOWNLOAD
                const pdfBlob = doc.output('blob');
                const url = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', `${b.name}_Bill.pdf`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.open(`https://wa.me/91${b.phone}?text=Bill from *${shop.name}* ready!`);
            }, 800);
        }

        window.loadLedger = () => {
            // ðŸ”¥ REAL-TIME LISTENER: No cache issue
            onValue(ref(db, `data/${shopId}/bills`), (snap) => {
                allBills = [];
                snap.forEach(c => allBills.push({id: c.key, ...c.val()}));
                renderLedger(allBills);
            });
        };

        function renderLedger(data) {
            const list = document.getElementById('billHistory'); list.innerHTML = "";
            data.slice().reverse().forEach(b => {
                const bal = b.total - b.paid;
                list.innerHTML += `<div class="bg-white p-5 rounded-[30px] border flex justify-between items-center shadow-sm">
                    <div><p class="font-black text-sm uppercase">${b.name}</p><p class="text-[10px] font-bold text-slate-400 italic">${b.brand} | â‚¹${bal}</p></div>
                    <div class="flex gap-2">
                        <button onclick="window.open('tel:${b.phone}')" class="p-4 bg-blue-50 text-blue-600 rounded-2xl">ðŸ“ž</button>
                        <button onclick="updatePayment('${b.id}', ${b.paid}, ${b.total}, '${b.phone}')" class="p-4 bg-slate-900 text-white rounded-2xl font-black italic">â‚¹</button>
                    </div>
                </div>`;
            });
        }

        window.searchLedger = () => {
            const q = document.getElementById('searchBox').value.toLowerCase();
            renderLedger(allBills.filter(b => b.name.toLowerCase().includes(q) || b.phone.includes(q)));
        };

        window.updatePayment = (id, oldP, total, phone) => {
            const amt = prompt("Received Amount?");
            if(amt) {
                const nP = parseFloat(oldP) + parseFloat(amt);
                update(ref(db, `data/${shopId}/bills/${id}`), { paid: nP }).then(() => {
                    window.open(`https://wa.me/91${phone}?text=Received â‚¹${amt}. Balance: â‚¹${total - nP}`);
                });
            }
        };

        window.tab = (t) => {
            document.getElementById('billingPage').classList.toggle('hidden', t !== 'billing');
            document.getElementById('ledgerPage').classList.toggle('hidden', t !== 'ledger');
        };

        window.onload = () => {
            const s = localStorage.getItem('saved_u');
            if(s) onValue(ref(db, `shops/${s}`), (snap) => { shop = snap.val().config; shopId = s; startApp(); }, {onlyOnce: true});
        };
    </script>
</body>
</html>
