<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Cloud Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-50 font-sans">

    <div id="loginPage" class="fixed inset-0 z-[2000] bg-white flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-10 tracking-tighter italic text-slate-900 underline decoration-blue-500">CLOUD BILLING</h1>
            <input id="uId" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-100 rounded-3xl outline-none font-bold">
            <input id="uPass" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-100 rounded-3xl outline-none font-bold">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-lg shadow-2xl">SIGN IN</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="bg-white p-6 shadow-sm flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <img id="sideLogo" class="w-10 h-10 rounded-xl object-contain bg-slate-100">
                <h1 id="headerShop" class="text-lg font-black text-slate-800 uppercase italic"></h1>
            </div>
            <button onclick="location.reload()" class="bg-red-50 text-red-500 px-3 py-1 rounded-lg text-[10px] font-bold">LOGOUT</button>
        </header>

        <div id="billingPage" class="p-4 space-y-6 pb-24">
            <div class="bg-white p-6 rounded-[35px] border space-y-4 shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Customer Info</h3>
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Device Info</h3>
                <select id="brand" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold">
                    <option value="iPhone">iPhone</option><option value="Samsung">Samsung</option>
                    <option value="Oppo">Oppo</option><option value="Realme">Realme</option>
                    <option value="Redmi">Redmi</option><option value="Motorola">Motorola</option>
                </select>
                <input id="imei" placeholder="IMEI Number" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2">Payment Details</h3>
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalP" type="number" onkeyup="reCalc()" placeholder="Total Price" class="p-4 bg-slate-50 rounded-2xl font-black text-blue-600 outline-none">
                    <div class="p-4 bg-blue-50 rounded-2xl text-center"><p class="text-[8px] font-bold text-blue-400">FINAL</p><p id="finalVal" class="text-lg font-black text-blue-700">â‚¹0</p></div>
                </div>
                
                <select id="payMode" onchange="toggleEMI()" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold">
                    <option value="Full">Full Payment</option>
                    <option value="EMI">EMI / Finance</option>
                </select>

                <div id="emiSection" class="hidden space-y-4 p-5 bg-yellow-50 rounded-[30px] border border-yellow-100">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-2xl outline-none font-bold">
                    <select id="emiMonths" onchange="reCalc()" class="w-full p-4 bg-white rounded-2xl outline-none font-bold">
                        <option value="3">3 Months EMI</option>
                        <option value="6">6 Months EMI</option>
                        <option value="9">9 Months EMI</option>
                        <option value="12">12 Months EMI</option>
                    </select>
                    <div class="flex justify-between items-center p-4 bg-white rounded-2xl">
                        <p class="text-xs font-bold text-slate-400 uppercase">Per Month</p>
                        <p id="mEmi" class="text-xl font-black text-red-500">â‚¹0</p>
                    </div>
                </div>
            </div>
            <button onclick="generateBill()" class="w-full bg-slate-900 text-white py-6 rounded-[30px] font-black text-lg shadow-2xl">SAVE & SEND PDF</button>
        </div>

        <div id="ledgerPage" class="hidden p-4 space-y-4 pb-24">
            <h3 class="font-black text-slate-800 ml-2">PAYMENT LEDGER</h3>
            <div id="billHistory" class="space-y-4"></div>
        </div>

        <nav class="fixed bottom-6 left-6 right-6 h-20 bg-slate-900 rounded-[35px] flex items-center justify-around px-8 shadow-2xl z-[100]">
            <button onclick="tab('billing')" class="text-white text-[10px] font-black uppercase tracking-widest">New Bill</button>
            <button onclick="tab('ledger')" class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Ledger</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let shop = null, shopId = null;

        window.doLogin = () => {
            const u = document.getElementById('uId').value.toLowerCase().trim();
            const p = document.getElementById('uPass').value;
            onValue(ref(db, `shops/${u}`), (snap) => {
                const d = snap.val();
                if(d && d.config.pass === p) {
                    shop = d.config; shopId = u;
                    localStorage.setItem('saved_u', u);
                    startApp();
                } else alert("Incorect Login!");
            }, {onlyOnce: true});
        };

        function startApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerShop').innerText = shop.name;
            document.getElementById('sideLogo').src = shop.logo;
            checkDueAlerts();
            loadLedger();
        }

        window.reCalc = () => {
            const p = parseFloat(document.getElementById('totalP').value || 0);
            document.getElementById('finalVal').innerText = "â‚¹" + p;
            if(document.getElementById('payMode').value === "EMI") {
                const dp = parseFloat(document.getElementById('downPay').value || 0);
                const m = parseFloat(document.getElementById('emiMonths').value);
                document.getElementById('mEmi').innerText = "â‚¹" + Math.round((p - dp) / m);
            }
        };

        window.toggleEMI = () => {
            document.getElementById('emiSection').classList.toggle('hidden', document.getElementById('payMode').value !== 'EMI');
        };

        window.generateBill = () => {
            const b = {
                name: document.getElementById('cN').value,
                phone: document.getElementById('cP').value,
                brand: document.getElementById('brand').value,
                imei: document.getElementById('imei').value,
                total: parseFloat(document.getElementById('totalP').value),
                paid: parseFloat(document.getElementById('downPay').value || document.getElementById('totalP').value),
                months: document.getElementById('payMode').value === "EMI" ? document.getElementById('emiMonths').value : 0,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            };
            push(ref(db, `data/${shopId}/bills`), b).then(() => {
                createPDF(b);
                const msg = `*${shop.name}*%0AHello ${b.name}, tumcha â‚¹${b.total} cha bill save jhale ahe.%0ADue Amount: â‚¹${b.total - b.paid}%0AVisit Again!`;
                window.open(`https://wa.me/91${b.phone}?text=${msg}`);
            });
        };

        function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            if(shop.logo) doc.addImage(shop.logo, 'JPEG', 15, 15, 30, 30);
            doc.setFontSize(22); doc.setTextColor(0, 50, 150); doc.text(shop.name, 50, 25);
            doc.setFontSize(9); doc.setTextColor(100); doc.text(shop.slogan, 50, 30);
            doc.text(`${shop.addr} | GST: ${shop.gst}`, 50, 35);

            // Watermark
            doc.setTextColor(245); doc.setFontSize(50);
            doc.text(shop.name, 105, 150, { align: "center", angle: 45 });

            // EMI Badge
            const bal = b.total - b.paid;
            doc.setFillColor(bal > 0 ? 255 : 50, bal > 0 ? 230 : 200, bal > 0 ? 230 : 200);
            doc.roundedRect(140, 45, 55, 12, 3, 3, 'F');
            doc.setFontSize(10); doc.setTextColor(0);
            doc.text(bal > 0 ? "EMI PENDING" : "PAID FULL", 167.5, 53, { align: "center" });

            doc.autoTable({
                startY: 65,
                head: [['Details', 'Info']],
                body: [
                    ['Customer', b.name], ['Mobile', b.phone], ['Device', b.brand],
                    ['IMEI', b.imei], ['Total', 'Rs.'+b.total], ['Paid', 'Rs.'+b.paid],
                    ['Balance', 'Rs.'+bal], ['EMI Tenure', b.months ? b.months+' Months' : 'N/A']
                ],
                theme: 'striped', headStyles: { fillColor: [0, 50, 150] }
            });

            doc.text("________________", 30, 240); doc.text("Customer Sign", 30, 245);
            doc.text("________________", 150, 240); doc.text("Owner Sign", 150, 245);
            doc.save(`${b.name}_Invoice.pdf`);
        }

        window.loadLedger = () => {
            onValue(ref(db, `data/${shopId}/bills`), (snap) => {
                const list = document.getElementById('billHistory'); list.innerHTML = "";
                snap.forEach(c => {
                    const b = c.val();
                    const bal = b.total - b.paid;
                    list.innerHTML += `<div class="bg-white p-5 rounded-[30px] shadow-sm border border-slate-100 flex justify-between items-center">
                        <div><p class="font-black text-slate-800 text-sm uppercase">${b.name}</p><p class="text-[10px] font-bold text-slate-400 italic">${b.brand} | Balance: â‚¹${bal}</p></div>
                        <div class="flex gap-2">
                            <button onclick="window.open('tel:${b.phone}')" class="p-3 bg-blue-50 text-blue-600 rounded-xl">ðŸ“ž</button>
                            <button onclick="updatePayment('${c.key}', ${b.paid}, ${b.total}, '${b.phone}')" class="p-3 bg-green-50 text-green-600 rounded-xl">â‚¹</button>
                        </div>
                    </div>`;
                });
            });
        };

        window.updatePayment = (id, oldPaid, total, phone) => {
            const amt = prompt("Amount Received Now?");
            if(amt) {
                const newPaid = parseFloat(oldPaid) + parseFloat(amt);
                update(ref(db, `data/${shopId}/bills/${id}`), { paid: newPaid }).then(() => {
                    alert("Payment Updated!");
                    window.open(`https://wa.me/91${phone}?text=Thank you! Your payment of â‚¹${amt} is received. Remaining: â‚¹${total - newPaid}`);
                });
            }
        };

        function checkDueAlerts() {
            onValue(ref(db, `data/${shopId}/bills`), (snap) => {
                snap.forEach(c => {
                    const b = c.val();
                    if((b.total - b.paid) > 0) {
                        alert(`DUE ALERT: ${b.name} has pending balance of â‚¹${b.total - b.paid}. Call them now!`);
                    }
                });
            }, {onlyOnce: true});
        }

        window.tab = (t) => {
            document.getElementById('billingPage').classList.toggle('hidden', t !== 'billing');
            document.getElementById('ledgerPage').classList.toggle('hidden', t !== 'ledger');
        };

        window.onload = () => {
            const s = localStorage.getItem('saved_u');
            if(s) onValue(ref(db, `shops/${s}`), (snap) => { shop = snap.val().config; shopId = s; startApp(); }, {onlyOnce: true});
        };
    </script>
</body>
</html>
