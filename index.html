<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Billing Pro | Tushar Dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="manifest" href="manifest.json">
</head>
<body class="bg-slate-50 font-sans select-none overflow-x-hidden text-slate-900">

    <div id="installBar" class="hidden fixed bottom-32 left-8 right-8 bg-blue-600 text-white p-5 rounded-[30px] z-[9999] shadow-2xl flex justify-between items-center border-2 border-white/20 animate-bounce">
        <div class="flex items-center gap-3">
            <span class="text-2xl">ðŸ“²</span>
            <p class="text-[10px] font-black uppercase tracking-widest">Install Billing App</p>
        </div>
        <button onclick="triggerInstall()" class="bg-white text-blue-600 px-6 py-2 rounded-xl font-black text-[10px]">INSTALL</button>
    </div>

    <div id="mainApp" class="min-h-screen">
        <header class="bg-white p-6 shadow-sm sticky top-0 z-50 pt-10 border-b">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <img id="sideLogo" src="" class="w-10 h-10 rounded-xl object-contain border hidden">
                    <h1 id="headerShop" class="text-lg font-black uppercase italic tracking-tighter">Elite Billing</h1>
                </div>
                <button onclick="location.reload()" class="bg-slate-100 p-2 rounded-xl text-[10px] font-black uppercase">Refresh</button>
            </div>
            <div class="bg-slate-900 text-white p-3 rounded-2xl flex justify-between items-center px-6">
                <div id="liveDate" class="text-[10px] font-bold opacity-70 uppercase">--/--/----</div>
                <div id="liveTime" class="text-lg font-black italic">00:00:00</div>
            </div>
        </header>

        <div id="billingPage" class="p-4 space-y-6 pb-40">
            <div class="bg-white p-6 rounded-[35px] border shadow-sm space-y-4">
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="dBrand" placeholder="Brand & Model" class="w-full p-4 bg-slate-50 rounded-2xl border font-bold uppercase">
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalP" type="number" onkeyup="reCalc()" placeholder="Total Price" class="p-4 bg-slate-50 rounded-2xl border font-black text-blue-600 text-center">
                    <div id="finalVal" class="p-4 bg-blue-600 rounded-2xl text-white font-black flex items-center justify-center">â‚¹0</div>
                </div>
                <div id="emiSection" class="space-y-4 p-5 bg-blue-50/50 rounded-[30px] border">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-2xl border font-black text-center">
                </div>
            </div>
            <button onclick="generateBill()" class="w-full bg-blue-600 text-white py-6 rounded-[30px] font-black text-xl shadow-2xl">GENERATE & DOWNLOAD PDF</button>
        </div>

        <div id="qrcode" class="hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Tumcha Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBar').classList.remove('hidden');
        });

        window.triggerInstall = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('installBar').classList.add('hidden');
            }
        };

        // Live Clock
        setInterval(() => {
            const now = new Date();
            document.getElementById('liveDate').innerText = now.toLocaleDateString('en-GB');
            document.getElementById('liveTime').innerText = now.toLocaleTimeString('en-GB', {hour12:true});
        }, 1000);

        window.generateBill = () => {
            const b = {
                name: document.getElementById('cN').value,
                phone: document.getElementById('cP').value,
                brand: document.getElementById('dBrand').value,
                total: parseFloat(document.getElementById('totalP').value),
                paid: parseFloat(document.getElementById('downPay').value || 0),
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString()
            };
            createPDF(b);
        };

        async function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Professional Design
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22); doc.text("TAX INVOICE", 15, 25);
            
            doc.autoTable({
                startY: 50,
                head: [['Details', 'Information']],
                body: [['Customer', b.name], ['Product', b.brand], ['Total', 'Rs.'+b.total], ['Paid', 'Rs.'+b.paid], ['Balance', 'Rs.'+(b.total - b.paid)]],
                theme: 'grid'
            });

            // ðŸ”¥ PDF DOWNLOAD & OPEN FIX FOR MOBILE
            try {
                // Method 1: Download
                doc.save(`${b.name}_bill.pdf`);
                
                // Method 2: Open in New Tab (For iPhone/iOS)
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            } catch (e) {
                alert("Please allow popups to see the bill.");
            }
        }
    </script>
</body>
</html>
