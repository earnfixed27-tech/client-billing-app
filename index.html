<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Elite Cloud Billing | Tushar Dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-50 font-sans select-none overflow-x-hidden text-slate-900">

    <div id="loginPage" class="fixed inset-0 z-[2000] bg-white flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <img id="loginLogo" src="" class="w-24 h-24 mx-auto mb-6 rounded-3xl object-contain bg-slate-100 p-2 hidden shadow-xl border">
            <h1 class="text-4xl font-black mb-10 tracking-tighter italic text-slate-900 underline decoration-blue-600 underline-offset-8">CLOUD BILLING</h1>
            <input id="uId" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <input id="uPass" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-5 rounded-[25px] font-black text-lg shadow-xl">SIGN IN</button>
        </div>
    </div>

    <div id="mainApp" class="hidden min-h-screen">
        <header class="bg-white p-6 shadow-sm sticky top-0 z-50 pt-10 border-b">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <img id="sideLogo" src="" class="w-10 h-10 rounded-xl object-contain bg-white border hidden shadow-sm">
                    <h1 id="headerShop" class="text-lg font-black uppercase italic"></h1>
                </div>
                <button onclick="doLogout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase">Logout</button>
            </div>
            <div class="bg-slate-900 text-white p-3 rounded-2xl flex justify-between items-center px-6 shadow-lg">
                <div id="liveDate" class="text-[10px] font-bold opacity-70 uppercase tracking-widest">--/--/----</div>
                <div id="liveTime" class="text-lg font-black italic tracking-tighter">00:00:00</div>
            </div>
        </header>

        <div id="billingPage" class="p-4 space-y-6 pb-40">
            <div class="bg-white p-6 rounded-[35px] border shadow-sm space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 italic underline decoration-blue-500 underline-offset-4">Registration</h3>
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="cA" placeholder="Full Address" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                
                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 italic">Product Details</h3>
                <input id="dBrand" placeholder="Brand (e.g. Samsung)" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold uppercase">
                <input id="dModel" placeholder="Model (e.g. S24 Ultra)" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold">
                <input id="imei" placeholder="IMEI / Serial" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">

                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 italic">Billing Strategy</h3>
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalP" type="number" onkeyup="reCalc()" placeholder="Total Price" class="p-4 bg-slate-50 rounded-2xl border font-black text-blue-600 outline-none text-center">
                    <div id="finalVal" class="p-4 bg-blue-600 rounded-2xl text-white font-black flex items-center justify-center italic">â‚¹0</div>
                </div>
                <select id="payMode" onchange="toggleEMI()" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold text-center">
                    <option value="Full">Full Payment</option>
                    <option value="EMI">EMI / Pending</option>
                </select>

                <div id="emiSection" class="hidden space-y-4 p-5 bg-blue-50/50 rounded-[30px] border border-blue-100">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-2xl border font-black text-center text-blue-600">
                    <input id="emiMonths" type="number" onkeyup="reCalc()" placeholder="Months" class="w-full p-4 bg-white rounded-2xl border font-bold text-center">
                    <div class="flex justify-between items-center px-4 py-2 text-blue-700 font-black">
                        <span class="text-[10px]">NEXT EMI:</span>
                        <span id="mEmi">â‚¹0</span>
                    </div>
                </div>
            </div>
            <button onclick="generateBill()" class="w-full bg-blue-600 text-white py-6 rounded-[30px] font-black text-xl shadow-2xl active:scale-95 transition">GENERATE PREMIUM INVOICE</button>
        </div>

        <div id="ledgerPage" class="hidden p-4 space-y-4 pb-40">
            <div id="billHistory" class="space-y-4"></div>
        </div>

        <div id="qrcode" class="hidden"></div>

        <nav class="fixed bottom-8 left-8 right-8 h-20 bg-slate-900/95 backdrop-blur-md rounded-[45px] flex items-center justify-around px-8 shadow-2xl z-[500]">
            <button onclick="tab('billing')" class="text-white text-[10px] font-black uppercase tracking-widest">New Bill</button>
            <button onclick="tab('ledger')" class="text-slate-500 text-[10px] font-black uppercase tracking-widest">History</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let shop = null, shopId = null;

        function updateTime() {
            const now = new Date();
            document.getElementById('liveDate').innerText = now.toLocaleDateString('en-GB');
            document.getElementById('liveTime').innerText = now.toLocaleTimeString('en-GB', { hour12: true });
        }
        setInterval(updateTime, 1000);

        window.doLogin = () => {
            const u = document.getElementById('uId').value.toLowerCase().trim();
            const p = document.getElementById('uPass').value;
            onValue(ref(db, `shops/${u}`), (snap) => {
                const d = snap.val();
                if(d && d.config.pass === p) {
                    shop = d.config; shopId = u;
                    localStorage.setItem('saved_u', u);
                    startApp();
                } else alert("Access Denied!");
            }, {onlyOnce: true});
        };

        window.doLogout = () => { if(confirm("Sign Out?")) { localStorage.clear(); location.reload(); } };

        function startApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerShop').innerText = shop.name;
            if(shop.logo) {
                document.getElementById('sideLogo').src = shop.logo;
                document.getElementById('sideLogo').classList.remove('hidden');
                document.getElementById('loginLogo').src = shop.logo;
                document.getElementById('loginLogo').classList.remove('hidden');
            }
            loadLedger();
        }

        window.reCalc = () => {
            const p = parseFloat(document.getElementById('totalP').value || 0);
            document.getElementById('finalVal').innerText = "â‚¹" + p;
            if(document.getElementById('payMode').value === "EMI") {
                const dp = parseFloat(document.getElementById('downPay').value || 0);
                const m = parseFloat(document.getElementById('emiMonths').value || 1);
                document.getElementById('mEmi').innerText = "â‚¹" + Math.round((p - dp) / m);
            }
        };

        window.toggleEMI = () => {
            document.getElementById('emiSection').classList.toggle('hidden', document.getElementById('payMode').value !== 'EMI');
        };

        window.generateBill = () => {
            const now = new Date();
            const b = {
                name: document.getElementById('cN').value, phone: document.getElementById('cP').value,
                addr: document.getElementById('cA').value, brand: document.getElementById('dBrand').value,
                model: document.getElementById('dModel').value, imei: document.getElementById('imei').value,
                total: parseFloat(document.getElementById('totalP').value),
                paid: parseFloat(document.getElementById('downPay').value || document.getElementById('totalP').value),
                months: document.getElementById('emiMonths').value || 0,
                date: now.toLocaleDateString(), time: now.toLocaleTimeString(), timestamp: Date.now()
            };
            if(!b.name || !b.total) return alert("Details Required!");
            push(ref(db, `data/${shopId}/bills`), b).then(() => createPDF(b));
        };

        async function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const bal = b.total - b.paid;

            // 1. Premium Header (Deep Blue Background)
            doc.setFillColor(15, 23, 42); doc.rect(0, 0, 210, 45, 'F');

            // 2. Logo Fix (Top Right Side)
            if(shop.logo) {
                try {
                    const img = new Image(); img.src = shop.logo; img.crossOrigin = "Anonymous";
                    await new Promise(r => img.onload = r);
                    doc.addImage(img, 'PNG', 165, 8, 28, 28);
                } catch(e) {}
            }

            // 3. Shop Name & Info (White Text - Bold)
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24); doc.setFont("helvetica", "bold");
            doc.text(shop.name.toUpperCase(), 15, 20);
            
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`${shop.addr}`, 15, 28);
            doc.text(`Contact: ${shop.phone1} | GST: ${shop.gst}`, 15, 34);
            doc.setFontSize(8); doc.text(`Date: ${b.date} | Time: ${b.time}`, 15, 40);

            // 4. Diagonal Watermark
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({opacity: 0.08}));
            doc.setFontSize(60); doc.setTextColor(150);
            doc.text(shop.name, 105, 150, { align: "center", angle: 45 });
            doc.restoreGraphicsState();

            // 5. Red/Green Badge
            doc.setFillColor(bal > 0 ? 220 : 34, bal > 0 ? 38 : 197, bal > 0 ? 38 : 94);
            doc.roundedRect(150, 50, 45, 12, 3, 3, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(9);
            doc.text(bal > 0 ? "EMI PENDING" : "PAID SUCCESS", 172.5, 57.5, { align: "center" });

            // 6. Tables (Clean & White Theme)
            doc.autoTable({
                startY: 70,
                head: [['CUSTOMER DETAILS', 'DEVICE DETAILS']],
                body: [[`Name: ${b.name}\nPhone: ${b.phone}\nAddress: ${b.addr}`, `Brand: ${b.brand}\nModel: ${b.model}\nIMEI: ${b.imei}`]],
                theme: 'grid', styles: { fontSize: 9, cellPadding: 5 }, headStyles: { fillColor: [51, 65, 85] }
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['DESCRIPTION', 'AMOUNT']],
                body: [['Total Device Value', 'Rs. '+b.total], ['Initial Down Payment', 'Rs. '+b.paid], ['Pending Balance', 'Rs. '+bal], ['EMI Tenure', b.months+' Months']],
                theme: 'striped', styles: { fontSize: 10, cellPadding: 5 }, headStyles: { fillColor: [15, 23, 42] }
            });

            // 7. Signature & Footer
            const fY = doc.lastAutoTable.finalY + 40;
            doc.setTextColor(15, 23, 42);
            doc.text("_______________________", 25, fY); doc.text("Customer Signature", 25, fY+5);
            doc.text("_______________________", 140, fY); doc.text("Authorized Signatory", 140, fY+5);

            // 8. Instagram QR & Slogan
            const igUrl = `https://instagram.com/${shop.insta}`;
            const qrDiv = document.getElementById('qrcode'); qrDiv.innerHTML = "";
            new QRCode(qrDiv, { text: igUrl, width: 100, height: 100 });
            
            setTimeout(() => {
                const qrImg = qrDiv.querySelector('img').src;
                doc.addImage(qrImg, 'PNG', 90, fY+15, 28, 28);
                doc.setFontSize(9); doc.setFont("helvetica", "italic");
                doc.text(shop.slogan, 105, fY+48, { align: "center" });
                doc.setFontSize(8); doc.setFont("helvetica", "normal");
                doc.text(`Follow @${shop.insta} on Instagram`, 105, fY+53, { align: "center" });
                doc.save(`${b.name}_Invoice.pdf`);
                window.open(`https://wa.me/91${b.phone}?text=Hello ${b.name}, invoice from *${shop.name}* is ready!`);
            }, 800);
        }

        window.loadLedger = () => {
            onValue(ref(db, `data/${shopId}/bills`), (snap) => {
                const list = document.getElementById('billHistory'); list.innerHTML = "";
                snap.forEach(c => {
                    const b = c.val();
                    list.innerHTML += `<div class="bg-white p-5 rounded-[30px] border flex justify-between items-center shadow-sm">
                        <div><p class="font-black text-sm uppercase">${b.name}</p><p class="text-[10px] font-bold text-slate-400 italic">${b.date} | ${b.time}</p></div>
                        <div class="flex gap-2">
                            <button onclick="window.open('tel:${b.phone}')" class="p-4 bg-blue-50 text-blue-600 rounded-2xl">ðŸ“ž</button>
                            <button onclick="updatePayment('${c.key}', ${b.paid}, ${b.total}, '${b.phone}')" class="p-4 bg-slate-900 text-white rounded-2xl font-black">â‚¹</button>
                        </div>
                    </div>`;
                });
            });
        };

        window.updatePayment = (id, oldP, total, phone) => {
            const amt = prompt("Receive Amount?");
            if(amt) {
                const nP = parseFloat(oldP) + parseFloat(amt);
                update(ref(db, `data/${shopId}/bills/${id}`), { paid: nP }).then(() => {
                    alert("Updated!");
                    window.open(`https://wa.me/91${phone}?text=Received â‚¹${amt}. Balance: â‚¹${total - nP}`);
                });
            }
        };

        window.tab = (t) => {
            document.getElementById('billingPage').classList.toggle('hidden', t !== 'billing');
            document.getElementById('ledgerPage').classList.toggle('hidden', t !== 'ledger');
        };

        window.onload = () => {
            updateTime();
            const s = localStorage.getItem('saved_u');
            if(s) onValue(ref(db, `shops/${s}`), (snap) => { shop = snap.val().config; shopId = s; startApp(); }, {onlyOnce: true});
        };
    </script>
</body>
</html>
