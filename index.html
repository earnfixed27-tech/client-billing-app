<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="manifest.json">
    <title>Elite Cloud Billing | Tushar Dev</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-50 font-sans select-none overflow-x-hidden">

    <div id="loginPage" class="fixed inset-0 z-[2000] bg-white flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <img id="loginLogo" src="" class="w-24 h-24 mx-auto mb-6 rounded-3xl object-contain bg-slate-100 p-2 hidden shadow-lg border">
            <h1 class="text-4xl font-black mb-10 tracking-tighter italic">CLOUD BILLING</h1>
            <input id="uId" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <input id="uPass" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-50 rounded-[25px] border outline-none font-bold">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-5 rounded-[25px] font-black shadow-xl">SIGN IN</button>
        </div>
    </div>

    <div id="mainApp" class="hidden min-h-screen">
        <header class="bg-white p-6 shadow-sm flex justify-between items-center sticky top-0 z-50 pt-10 border-b">
            <div class="flex items-center gap-4">
                <img id="sideLogo" src="" class="w-10 h-10 rounded-xl object-contain bg-white border hidden shadow-sm">
                <h1 id="headerShop" class="text-lg font-black text-slate-800 uppercase italic"></h1>
            </div>
            <button onclick="location.reload()" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest">Logout</button>
        </header>

        <div id="billingPage" class="p-4 space-y-6 pb-40">
            <div class="bg-white p-6 rounded-[35px] border shadow-sm space-y-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest italic decoration-blue-500 underline underline-offset-4">Invoice Info</h3>
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                <input id="cA" placeholder="Address (Full)" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">
                
                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest italic">Product Info</h3>
                <input id="dBrand" placeholder="Brand Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold uppercase">
                <input id="dModel" placeholder="Model Name" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold">
                <input id="imei" placeholder="IMEI / Serial No." class="w-full p-4 bg-slate-50 rounded-2xl border outline-none">

                <h3 class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-widest italic">Billing</h3>
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalP" type="number" onkeyup="reCalc()" placeholder="Total Price" class="p-4 bg-slate-50 rounded-2xl border font-black text-blue-600 outline-none text-center">
                    <div id="finalVal" class="p-4 bg-blue-600 rounded-2xl text-white font-black flex items-center justify-center italic">â‚¹0</div>
                </div>
                <select id="payMode" onchange="toggleEMI()" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold text-center">
                    <option value="Full">Fully Paid</option>
                    <option value="EMI">EMI / Pending Payment</option>
                </select>

                <div id="emiSection" class="hidden space-y-4 p-5 bg-yellow-50 rounded-[30px] border border-yellow-100 animate-pulse">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-2xl border font-black text-center">
                    <input id="emiMonths" type="number" onkeyup="reCalc()" placeholder="Tenure (Months)" class="w-full p-4 bg-white rounded-2xl border font-bold text-center">
                    <div class="flex justify-between items-center px-4 py-2 bg-white rounded-2xl text-red-600 font-black border border-red-100">
                        <span class="text-[10px]">MONTHLY INST.:</span>
                        <span id="mEmi">â‚¹0</span>
                    </div>
                </div>
            </div>
            <button onclick="generateBill()" class="w-full bg-slate-900 text-white py-6 rounded-[30px] font-black text-xl shadow-2xl active:scale-95 transition">GENERATE ELITE PDF</button>
        </div>

        <div id="ledgerPage" class="hidden p-4 space-y-4 pb-40">
            <div class="bg-white p-4 rounded-[30px] shadow-sm sticky top-28 z-40 border space-y-3">
                <input id="searchBox" onkeyup="searchLedger()" placeholder="ðŸ” Search History..." class="w-full p-4 bg-slate-50 rounded-2xl border outline-none font-bold">
                <div class="flex gap-2">
                    <button onclick="filterType('all')" class="flex-1 py-2 bg-slate-900 text-white rounded-xl font-black text-[10px]">ALL</button>
                    <button onclick="filterType('pending')" class="flex-1 py-2 bg-red-100 text-red-600 rounded-xl font-black text-[10px]">DUE</button>
                </div>
            </div>
            <div id="billHistory" class="space-y-4"></div>
        </div>

        <div id="qrcode" class="hidden"></div>

        <nav class="fixed bottom-8 left-8 right-8 h-20 bg-slate-900/95 backdrop-blur-md rounded-[40px] flex items-center justify-around px-8 shadow-2xl z-[500]">
            <button onclick="tab('billing')" class="text-white text-[10px] font-black uppercase tracking-widest">Billing</button>
            <button onclick="tab('ledger')" class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Ledger</button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let shop = null, shopId = null, allBills = [];

        window.doLogin = () => {
            const u = document.getElementById('uId').value.toLowerCase().trim();
            const p = document.getElementById('uPass').value;
            onValue(ref(db, `shops/${u}`), (snap) => {
                const d = snap.val();
                if(d && d.config.pass === p) {
                    shop = d.config; shopId = u;
                    localStorage.setItem('saved_u', u);
                    startApp();
                } else alert("Invalid Login!");
            }, {onlyOnce: true});
        };

        function startApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerShop').innerText = shop.name;
            if(shop.logo) {
                document.getElementById('sideLogo').src = shop.logo;
                document.getElementById('sideLogo').classList.remove('hidden');
                document.getElementById('loginLogo').src = shop.logo;
                document.getElementById('loginLogo').classList.remove('hidden');
            }
            loadLedger();
        }

        window.reCalc = () => {
            const p = parseFloat(document.getElementById('totalP').value || 0);
            document.getElementById('finalVal').innerText = "â‚¹" + p;
            if(document.getElementById('payMode').value === "EMI") {
                const dp = parseFloat(document.getElementById('downPay').value || 0);
                const m = parseFloat(document.getElementById('emiMonths').value || 1);
                document.getElementById('mEmi').innerText = "â‚¹" + Math.round((p - dp) / m);
            }
        };

        window.toggleEMI = () => {
            document.getElementById('emiSection').classList.toggle('hidden', document.getElementById('payMode').value !== 'EMI');
        };

        window.generateBill = () => {
            const b = {
                name: document.getElementById('cN').value, phone: document.getElementById('cP').value,
                addr: document.getElementById('cA').value, brand: document.getElementById('dBrand').value,
                model: document.getElementById('dModel').value, imei: document.getElementById('imei').value,
                total: parseFloat(document.getElementById('totalP').value),
                paid: parseFloat(document.getElementById('downPay').value || document.getElementById('totalP').value),
                months: document.getElementById('emiMonths').value || 0,
                date: new Date().toLocaleDateString(), timestamp: Date.now()
            };
            push(ref(db, `data/${shopId}/bills`), b).then(() => createPDF(b));
        };

        async function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const bal = b.total - b.paid;

            // 1. Logo Fix
            if(shop.logo) {
                const img = new Image(); img.src = shop.logo; img.crossOrigin = "Anonymous";
                await new Promise(r => img.onload = r);
                doc.addImage(img, 'PNG', 15, 12, 25, 25);
            }

            // 2. Header
            doc.setFontSize(24); doc.setTextColor(15, 23, 42); doc.text(shop.name, 45, 22);
            doc.setFontSize(9); doc.setTextColor(100); doc.text(shop.slogan, 45, 27);
            doc.text(`${shop.addr} | GST: ${shop.gst}`, 45, 32);

            // 3. Perfect Diagonal Watermark
            doc.saveGraphicsState();
            doc.setGState(new doc.GState({opacity: 0.1}));
            doc.setFontSize(60); doc.setTextColor(150);
            doc.text(shop.name, 105, 150, { align: "center", angle: 45 });
            doc.restoreGraphicsState();

            // 4. Badges (Red for Pending, Green for Success)
            doc.setFillColor(bal > 0 ? 255 : 34, bal > 0 ? 241 : 197, bal > 0 ? 242 : 94);
            doc.roundedRect(145, 40, 50, 15, 4, 4, 'F');
            doc.setFontSize(10); doc.setTextColor(bal > 0 ? 220 : 255, 38, 38);
            doc.text(bal > 0 ? "PAYMENT PENDING" : "PAYMENT SUCCESS", 170, 49.5, { align: "center" });

            // 5. Tables
            doc.autoTable({
                startY: 65,
                head: [['CUSTOMER INFO', 'DEVICE DETAILS']],
                body: [[`Name: ${b.name}\nPhone: ${b.phone}\nAddr: ${b.addr}`, `Brand: ${b.brand}\nModel: ${b.model}\nIMEI: ${b.imei}\nDate: ${b.date}`]],
                theme: 'grid', styles: { fontSize: 9 }
            });

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['INVOICE SUMMARY', 'TOTAL']],
                body: [['Total Valuation', 'Rs. '+b.total], ['Down Payment', 'Rs. '+b.paid], ['Outstanding Bal', 'Rs. '+bal], ['Tenure', b.months+' Months']],
                theme: 'striped', headStyles: { fillColor: [15, 23, 42] }
            });

            // 6. Signature Sections
            doc.setFontSize(10); doc.setTextColor(50);
            doc.text("_______________________", 30, 240); doc.text("Customer Signature", 30, 245);
            doc.text("_______________________", 140, 240); doc.text("Authorized Signature", 140, 245);

            // 7. IG QR Code Integration
            const igUrl = `https://instagram.com/${shop.insta}`;
            const qrDiv = document.getElementById('qrcode'); qrDiv.innerHTML = "";
            new QRCode(qrDiv, { text: igUrl, width: 100, height: 100 });
            
            setTimeout(() => {
                const qrImg = qrDiv.querySelector('img').src;
                doc.addImage(qrImg, 'PNG', 90, 250, 30, 30);
                doc.setFontSize(8); doc.text(`Scan to follow @${shop.insta}`, 105, 285, { align: "center" });
                doc.save(`${b.name}_Invoice.pdf`);
                window.open(`https://wa.me/91${b.phone}?text=Invoice from *${shop.name}* ready!`);
            }, 500);
        }

        window.loadLedger = () => {
            onValue(ref(db, `data/${shopId}/bills`), (snap) => {
                allBills = [];
                snap.forEach(c => allBills.push({id: c.key, ...c.val()}));
                renderLedger(allBills);
            });
        };

        function renderLedger(data) {
            const list = document.getElementById('billHistory'); list.innerHTML = "";
            data.slice().reverse().forEach(b => {
                const bal = b.total - b.paid;
                list.innerHTML += `<div class="bg-white p-5 rounded-[30px] border flex justify-between items-center">
                    <div><p class="font-black text-slate-800 uppercase text-sm">${b.name}</p><p class="text-[10px] font-bold text-slate-400 uppercase italic">${b.brand} | Bal: â‚¹${bal}</p></div>
                    <div class="flex gap-2">
                        <button onclick="window.open('tel:${b.phone}')" class="p-4 bg-blue-50 text-blue-600 rounded-2xl">ðŸ“ž</button>
                        <button onclick="updatePayment('${b.id}', ${b.paid}, ${b.total}, '${b.phone}')" class="p-4 bg-slate-900 text-white rounded-2xl font-black italic">â‚¹</button>
                    </div>
                </div>`;
            });
        }

        window.updatePayment = (id, oldP, total, phone) => {
            const amt = prompt("Amount Received?");
            if(amt) {
                const nP = parseFloat(oldP) + parseFloat(amt);
                update(ref(db, `data/${shopId}/bills/${id}`), { paid: nP }).then(() => {
                    window.open(`https://wa.me/91${phone}?text=Payment of â‚¹${amt} received. Balance: â‚¹${total - nP}`);
                });
            }
        };

        window.tab = (t) => {
            document.getElementById('billingPage').classList.toggle('hidden', t !== 'billing');
            document.getElementById('ledgerPage').classList.toggle('hidden', t !== 'ledger');
        };

        window.onload = () => {
            const s = localStorage.getItem('saved_u');
            if(s) onValue(ref(db, `shops/${s}`), (snap) => { shop = snap.val().config; shopId = s; startApp(); }, {onlyOnce: true});
        };
    </script>
</body>
</html>
