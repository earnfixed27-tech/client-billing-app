<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Billing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-slate-50 font-sans">
    <div id="loginPage" class="fixed inset-0 bg-white z-[1000] flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl font-black mb-10 tracking-tighter">CLOUD BILLING</h1>
            <input id="u" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-100 rounded-[24px] outline-none focus:ring-2 ring-blue-500">
            <input id="p" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-100 rounded-[24px] outline-none focus:ring-2 ring-blue-500">
            <button onclick="shopLogin()" class="w-full bg-slate-900 text-white py-5 rounded-[24px] font-black text-lg shadow-2xl">SIGN IN</button>
        </div>
    </div>

    <div id="appBody" class="hidden p-4 max-w-md mx-auto pt-10">
        <header class="flex justify-between items-center mb-8">
            <h2 id="sTitle" class="text-xl font-black uppercase italic text-slate-800"></h2>
            <button onclick="downloadExcel()" class="bg-green-100 text-green-600 p-3 rounded-2xl text-[10px] font-black">EXCEL BACKUP</button>
        </header>
        </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.shopLogin = () => {
            const u = document.getElementById('u').value.toLowerCase().trim();
            const p = document.getElementById('p').value;
            onValue(ref(db, 'shops/' + u), (snap) => {
                const d = snap.val();
                if(d && d.pass === p) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('appBody').classList.remove('hidden');
                    document.getElementById('sTitle').innerText = d.name;
                    localStorage.setItem('vId', u);
                } else { alert("Invalid Credentials!"); }
            }, {onlyOnce: true});
        };

        window.downloadExcel = () => {
            const vId = localStorage.getItem('vId');
            onValue(ref(db, 'data/' + vId + '/bills'), (snap) => {
                let csv = "Date,Name,Total\n";
                snap.forEach(c => { const v = c.val(); csv += `${v.date},${v.name},${v.total}\n`; });
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = `${vId}_Backup.csv`; a.click();
            }, {onlyOnce: true});
        };
    </script>
</body>
</html>
