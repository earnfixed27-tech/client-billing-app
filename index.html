<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Billing | Tushar Developer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-50 font-sans min-h-screen pb-24">

    <div id="loginPage" class="fixed inset-0 z-[2000] bg-white flex items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-10 tracking-tighter text-slate-800 italic">CLOUD BILLING</h1>
            <input id="uId" placeholder="Shop ID" class="w-full p-5 mb-4 bg-slate-100 rounded-3xl outline-none focus:ring-2 ring-blue-500 font-bold">
            <input id="uPass" type="password" placeholder="Password" class="w-full p-5 mb-10 bg-slate-100 rounded-3xl outline-none focus:ring-2 ring-blue-500 font-bold">
            <button onclick="doLogin()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-lg shadow-2xl">SIGN IN</button>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="bg-white p-6 shadow-sm sticky top-0 z-50 flex justify-between items-center">
            <div>
                <h1 id="headerShopName" class="text-xl font-black text-blue-600 uppercase italic leading-tight">SHOP NAME</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Premium Partner</p>
            </div>
            <button onclick="location.reload()" class="bg-red-50 text-red-500 p-2 rounded-xl text-[10px] font-bold">LOGOUT</button>
        </header>

        <div id="billingPage" class="p-4 space-y-6">
            <div class="bg-white p-6 rounded-[35px] shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Customer Details</h3>
                <input id="cN" placeholder="Customer Name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-blue-500">
                <input id="cP" type="number" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
                <input id="cA" placeholder="Address" class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
            </div>

            <div class="bg-white p-6 rounded-[35px] shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Device Info</h3>
                <select id="brand" onchange="checkManualBrand()" class="w-full p-4 bg-slate-50 rounded-2xl outline-none appearance-none font-bold">
                    <option value="iPhone">iPhone</option>
                    <option value="Samsung">Samsung</option>
                    <option value="Oppo">Oppo</option>
                    <option value="Realme">Realme</option>
                    <option value="Redmi">Redmi</option>
                    <option value="Infinix">Infinix</option>
                    <option value="Motorola">Motorola</option>
                    <option value="MANUAL">-- Type Manually --</option>
                </select>
                <input id="manualBrand" placeholder="Enter Brand & Model Name" class="hidden w-full p-4 bg-slate-50 rounded-2xl outline-none border-2 border-blue-100">
                <input id="imei" placeholder="IMEI / Serial No." class="w-full p-4 bg-slate-50 rounded-2xl outline-none">
            </div>

            <div class="bg-white p-6 rounded-[35px] shadow-sm border border-slate-100 space-y-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Payment & Offers</h3>
                <div class="flex gap-2">
                    <button onclick="setOffer(0)" id="off0" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-xs">0%</button>
                    <button onclick="setOffer(2)" id="off2" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-xs">2%</button>
                    <button onclick="setOffer(5)" id="off5" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-xs">5%</button>
                    <button onclick="setOffer(10)" id="off10" class="flex-1 py-3 rounded-xl bg-slate-100 font-bold text-xs text-blue-600 border border-blue-200">10%</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input id="totalPrice" type="number" onkeyup="reCalc()" placeholder="Price" class="p-4 bg-slate-50 rounded-2xl outline-none font-black text-blue-600">
                    <div class="p-4 bg-blue-50 rounded-2xl text-center">
                        <p class="text-[8px] font-bold text-blue-400 uppercase">Final Price</p>
                        <p id="finalP" class="text-lg font-black text-blue-700">₹0</p>
                    </div>
                </div>
                <select id="payMode" onchange="toggleEMI()" class="w-full p-4 bg-slate-50 rounded-2xl outline-none font-bold">
                    <option value="Cash">Cash Payment</option>
                    <option value="UPI">UPI / Online</option>
                    <option value="EMI">EMI / Finance</option>
                </select>
                
                <div id="emiSection" class="hidden space-y-3 p-4 bg-yellow-50 rounded-[28px] border border-yellow-100">
                    <input id="downPay" type="number" onkeyup="reCalc()" placeholder="Down Payment" class="w-full p-4 bg-white rounded-xl outline-none font-bold">
                    <div class="grid grid-cols-2 gap-2">
                        <input id="emiMonths" type="number" placeholder="Months" class="p-4 bg-white rounded-xl outline-none text-sm">
                        <div class="p-3 bg-white rounded-xl text-center">
                            <p class="text-[8px] font-bold text-slate-400">NEXT EMI</p>
                            <p id="emiAmt" class="text-sm font-black text-red-500">₹0</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="generateBill()" class="w-full bg-slate-900 text-white py-6 rounded-[30px] font-black text-lg shadow-2xl active:scale-95 transition-all">GENERATE & WHATSAPP</button>
        </div>

        <div id="ledgerPage" class="hidden p-4 space-y-4">
            <div class="flex bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <button onclick="filterBills('all')" class="flex-1 py-3 font-bold text-xs rounded-xl bg-slate-900 text-white">ALL</button>
                <button onclick="filterBills('pending')" class="flex-1 py-3 font-bold text-xs rounded-xl text-slate-500">PENDING</button>
            </div>
            <input id="searchBox" onkeyup="searchBill()" placeholder="Search by name or number..." class="w-full p-4 bg-white rounded-2xl shadow-sm outline-none border border-slate-100">
            <div id="billHistory" class="space-y-4"></div>
        </div>

        <nav class="fixed bottom-6 left-6 right-6 h-20 bg-slate-900 rounded-[30px] flex items-center justify-around px-4 shadow-2xl z-[100]">
            <button onclick="tab('billing')" class="flex flex-col items-center gap-1">
                <span class="text-white text-[10px] font-black uppercase tracking-widest">New Bill</span>
            </button>
            <button onclick="tab('ledger')" class="flex flex-col items-center gap-1">
                <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Ledger</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgDH1ovCNJ5gLDsEpnnYzwVmMQT8Yutss",
            databaseURL: "https://tushardeveloper-f11d5-default-rtdb.firebaseio.com",
            projectId: "tushardeveloper-f11d5",
            appId: "1:715461297322:web:974d61939443563c51bcd3"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let shopConfig = null;
        let currentShopId = null;
        let activeOffer = 0;

        window.doLogin = () => {
            const u = document.getElementById('uId').value.toLowerCase().trim();
            const p = document.getElementById('uPass').value;
            onValue(ref(db, `shops/${u}`), (snap) => {
                const d = snap.val();
                if(d && d.config.pass === p) {
                    shopConfig = d.config;
                    currentShopId = u;
                    localStorage.setItem('saved_shop', u);
                    initApp();
                } else { alert("Access Denied!"); }
            }, {onlyOnce: true});
        };

        function initApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('headerShopName').innerText = shopConfig.name;
            loadLedger();
        }

        window.setOffer = (val) => {
            activeOffer = val;
            reCalc();
        };

        window.reCalc = () => {
            const price = parseFloat(document.getElementById('totalPrice').value || 0);
            const discount = (price * activeOffer) / 100;
            const final = price - discount;
            document.getElementById('finalP').innerText = "₹" + final;
            
            if(document.getElementById('payMode').value === "EMI") {
                const dp = parseFloat(document.getElementById('downPay').value || 0);
                const months = parseFloat(document.getElementById('emiMonths').value || 1);
                document.getElementById('emiAmt').innerText = "₹" + Math.round((final - dp) / months);
            }
        };

        window.generateBill = () => {
            const finalP = parseFloat(document.getElementById('finalP').innerText.replace('₹',''));
            const dp = parseFloat(document.getElementById('downPay').value || 0);
            const bal = finalP - dp;

            const billData = {
                name: document.getElementById('cN').value,
                phone: document.getElementById('cP').value,
                addr: document.getElementById('cA').value,
                brand: document.getElementById('brand').value === "MANUAL" ? document.getElementById('manualBrand').value : document.getElementById('brand').value,
                imei: document.getElementById('imei').value,
                total: finalP,
                paid: dp,
                balance: bal,
                mode: document.getElementById('payMode').value,
                date: new Date().toLocaleDateString(),
                timestamp: Date.now()
            };

            push(ref(db, `data/${currentShopId}/bills`), billData).then(() => {
                createPDF(billData);
                sendWhatsApp(billData);
            });
        };

        function createPDF(b) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Header
            doc.setFontSize(22); doc.setTextColor(0, 102, 204);
            doc.text(shopConfig.name, 105, 20, { align: "center" });
            
            doc.setFontSize(10); doc.setTextColor(100);
            doc.text(shopConfig.slogan, 105, 26, { align: "center" });
            doc.text(`${shopConfig.addr} | Contact: ${shopConfig.phone1}`, 105, 32, { align: "center" });
            
            // Watermark
            doc.setTextColor(240); doc.setFontSize(60);
            doc.text(shopConfig.name, 105, 150, { align: "center", angle: 45 });
            
            // Premium Badge
            doc.setFillColor(b.balance > 0 ? 255 : 46, b.balance > 0 ? 239 : 204, b.balance > 0 ? 239 : 113);
            doc.roundedRect(150, 45, 45, 12, 3, 3, 'F');
            doc.setTextColor(b.balance > 0 ? 200 : 255, 0, 0);
            doc.text(b.balance > 0 ? "EMI PENDING" : "PAID SUCCESS", 172, 53, { align: "center" });

            // Table
            doc.autoTable({
                startY: 65,
                head: [['Details', 'Information']],
                body: [
                    ['Customer', b.name], ['Phone', b.phone], ['Device', b.brand],
                    ['IMEI', b.imei], ['Total Amount', 'Rs.' + b.total],
                    ['Paid Amount', 'Rs.' + b.paid], ['Balance Due', 'Rs.' + b.balance]
                ],
                theme: 'grid', headStyles: { fillColor: [0, 102, 204] }
            });

            // Footer
            doc.setTextColor(0); doc.text("Thank you for visiting! Please visit again.", 105, 250, { align: "center" });
            doc.save(`${b.name}_Invoice.pdf`);
        }

        function sendWhatsApp(b) {
            let msg = `*${shopConfig.name}*%0AHello ${b.name}, tumche bill tayaar ahe.%0ADevice: ${b.brand}%0ATotal: ₹${b.total}%0ABalance: ₹${b.balance}%0AVisit Again!%0A- Owner: ${shopConfig.phone1}`;
            window.open(`https://wa.me/91${b.phone}?text=${msg}`);
        }

        window.tab = (t) => {
            document.getElementById('billingPage').classList.toggle('hidden', t !== 'billing');
            document.getElementById('ledgerPage').classList.toggle('hidden', t !== 'ledger');
        };

        window.checkManualBrand = () => {
            document.getElementById('manualBrand').classList.toggle('hidden', document.getElementById('brand').value !== 'MANUAL');
        };

        // Auto Load if session exists
        window.onload = () => {
            const saved = localStorage.getItem('saved_shop');
            if(saved) {
                onValue(ref(db, `shops/${saved}`), (snap) => {
                    shopConfig = snap.val().config;
                    currentShopId = saved;
                    initApp();
                }, {onlyOnce: true});
            }
        };

        function loadLedger() {
            onValue(ref(db, `data/${currentShopId}/bills`), (snap) => {
                const container = document.getElementById('billHistory');
                container.innerHTML = "";
                snap.forEach(c => {
                    const b = c.val();
                    const card = `
                        <div class="bg-white p-5 rounded-[30px] shadow-sm border border-slate-100 flex justify-between items-center">
                            <div>
                                <h4 class="font-black text-slate-800 text-sm uppercase">${b.name}</h4>
                                <p class="text-[10px] font-bold text-slate-400 italic">${b.brand} | ${b.date}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black ${b.balance > 0 ? 'text-red-500' : 'text-green-600'}">₹${b.balance}</p>
                                <button onclick="window.open('tel:${b.phone}')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">CALL</button>
                            </div>
                        </div>`;
                    container.innerHTML += card;
                });
            });
        }
    </script>
</body>
</html>
